@{
    ViewBag.Title = "HomePage";
}

<div class="container-fluid">
    <!-- First Row - Top Quadrants -->
    <div class="row">
        <!-- Top Left Quadrant - Book Ambulance Content -->
        <div class="col-md-6 p-5">
            <div class="text-center h-100 d-flex flex-column justify-content-center">
                <h2>A real O.K. team here to try and save you</h2>
                <p class="mb-4">If you're still breathing once you've reached the hospital, we've done our job successfully:</p>
                <a href="@Url.Action("SelectService", "Booking")" class="btn btn-primary btn-lg mx-auto">BOOK AMBULANCE</a>
            </div>
        </div>

        <!-- Top Right Quadrant - Image -->
        <div class="col-md-6 p-0">
            <img src="/Images/Hospital.jpg" alt="Ambulance" class="img-fluid w-100 h-100" style="object-fit: cover;">
        </div>
    </div>

    <!-- Second Row - Bottom Quadrants -->
    <div class="row">
        <!-- Bottom Left Quadrant - SOS Button as Image -->
        <div class="col-md-6 p-0">
            <button id="sosButton" class="btn p-0 border-0 w-100 h-100">
                <img src="/Images/SOS.jpg" alt="Emergency SOS" class="img-fluid w-100 h-100" style="object-fit: cover;">
            </button>
        </div>

        <!-- Bottom Right Quadrant - Text Content -->
        <div class="col-md-6 p-5">
            <div class="h-100 d-flex flex-column justify-content-center">
                <h3>EMERGENCY?</h3>
                <p>Only hit the button for <strong>real</strong> emergencies mind you.</p>
                <p class="text-muted small">Stepping on a thumbtack at 3 cm while doing arts and crafts is not an emergency.</p>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // S.O.S button click handler
            $("#sosButton").click(function(e) {
                e.preventDefault();

                // Get service types from server
                const serviceTypes = [
                    @foreach (var service in HomeworkAssignment1.Models.Services.serviceTypes)
                    {
                        <text>'@service',</text>
                    }
                ];

                // Get available drivers and vehicles with images
                const availableDrivers = [];
                const availableVehicles = [];

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);

                    // Check for drivers (including those with images)
                    if (key.startsWith('driver_')) {
                        const driverData = localStorage.getItem(key).split('|');
                        if (driverData.length >= 4) {
                            const driver = {
                                driverID: key.replace('driver_', ''),
                                firstName: driverData[0],
                                lastName: driverData[1],
                                phone: driverData[2],
                                serviceType: driverData[3],
                                image: driverData.length > 4 ? driverData[4] : '/Content/images/default-driver.jpg'
                            };
                            availableDrivers.push(driver);
                        }
                    }

                    // Check for vehicles (including those with images)
                    if (key.startsWith('vehicle_')) {
                        const vehicleData = localStorage.getItem(key).split('|');
                        if (vehicleData.length >= 3) {
                            const vehicle = {
                                vehicleID: key.replace('vehicle_', ''),
                                vehicleType: vehicleData[0],
                                registration: vehicleData[1],
                                serviceType: vehicleData[2],
                                image: vehicleData.length > 3 ? vehicleData[3] : '/Content/images/default-vehicle.jpg'
                            };
                            availableVehicles.push(vehicle);
                        }
                    }
                }

                // Try each service type until we find one with available drivers and vehicles
                let selectedService = null;
                let serviceDrivers = [];
                let serviceVehicles = [];

                // Shuffle service types to randomize selection
                const shuffledServices = [...serviceTypes].sort(() => 0.5 - Math.random());

                for (const service of shuffledServices) {
                    serviceDrivers = availableDrivers.filter(d => d.serviceType === service);
                    serviceVehicles = availableVehicles.filter(v => v.serviceType === service);

                    if (serviceDrivers.length > 0 && serviceVehicles.length > 0) {
                        selectedService = service;
                        break;
                    }
                }

                if (!selectedService) {
                    alert("No available drivers or vehicles for any service type");
                    return;
                }

                // Select random driver and vehicle
                const randomDriver = serviceDrivers[Math.floor(Math.random() * serviceDrivers.length)];
                const randomVehicle = serviceVehicles[Math.floor(Math.random() * serviceVehicles.length)];

                // Create booking key
                const bookingKey = 'emergency_' + Date.now();

                // Store booking data in localStorage
                localStorage.setItem(bookingKey + '_serviceType', selectedService);
                localStorage.setItem(bookingKey + '_id', generateGUID());
                localStorage.setItem(bookingKey + '_fullName', 'EMERGENCY PATIENT');
                localStorage.setItem(bookingKey + '_phone', '000-000-0000');
                localStorage.setItem(bookingKey + '_pickUpTime', new Date().toLocaleTimeString());
                localStorage.setItem(bookingKey + '_reason', 'Emergency');
                localStorage.setItem(bookingKey + '_address', 'Emergency Location');
                localStorage.setItem(bookingKey + '_date', new Date().toISOString());
                localStorage.setItem(bookingKey + '_isEmergency', 'true');
                localStorage.setItem(bookingKey + '_driverId', randomDriver.driverID);
                localStorage.setItem(bookingKey + '_vehicleId', randomVehicle.vehicleID);

                // Store complete driver data including image
                localStorage.setItem(bookingKey + '_driverData',
                    `${randomDriver.firstName}|${randomDriver.lastName}|${randomDriver.phone}|${randomDriver.serviceType}|${randomDriver.image}`);
                localStorage.setItem(bookingKey + '_driverImage', randomDriver.image);

                // Store complete vehicle data including image
                localStorage.setItem(bookingKey + '_vehicleType', randomVehicle.vehicleType);
                localStorage.setItem(bookingKey + '_vehicleReg', randomVehicle.registration);
                localStorage.setItem(bookingKey + '_vehicleService', randomVehicle.serviceType);
                localStorage.setItem(bookingKey + '_vehicleImage', randomVehicle.image);

                // Add to bookings list
                let bookings = localStorage.getItem('bookingKeys') || '';
                if (bookings) bookings += ',';
                bookings += bookingKey;
                localStorage.setItem('bookingKeys', bookings);

                // Set as current booking
                localStorage.setItem('currentBookingKey', bookingKey);

                // Redirect to confirmation page with full key
                window.location.href = '@Url.Action("ConfirmBooking", "Booking")?bookingId=' + bookingKey;
            });

            function generateGUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        });
    </script>
}