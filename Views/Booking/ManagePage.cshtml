@model HomeworkAssignment1.Models.Manage

@{
    ViewBag.Title = "Manage Drivers and Vehicles";
}

<h2>Driver and Vehicle Management</h2>

@if (TempData["DriverAdded"] != null && (bool)TempData["DriverAdded"])
{
    <script>
        var driverData = '@TempData["NewDriver"]'.split('|');
        var driverId = driverData[0];
        var driverDetails = driverData.slice(1).join('|');
        localStorage.setItem('driver_' + driverId, driverDetails);
        window.location.href = '@Url.Action("ManagePage")';
    </script>
}

<div class="row">
    <div class="col-md-12">
        <h3>Drivers</h3>
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="driverSearch" class="form-control" placeholder="Search by name">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="searchDriversBtn">Search</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <select class="form-control" id="serviceTypeFilter">
                        <option value="">All Service Types</option>
                        @foreach (var service in HomeworkAssignment1.Models.Services.serviceTypes)
                        {
                            <option value="@service">@service</option>
                        }
                    </select>
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="filterServiceBtn">Filter</button>
                    </div>
                </div>
            </div>
        </div>

        <table class="table" id="driversTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Service</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="driversList">
                <!-- Will be populated by jQuery -->
            </tbody>
        </table>

        <a href="@Url.Action("AddDriver", "Booking")" class="btn btn-primary">Add Driver</a>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h3>Vehicles</h3>
        <table class="table" id="vehiclesTable">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Registration</th>
                    <th>Service</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="vehiclesList">
                <!-- Will be populated by jQuery -->
            </tbody>
        </table>

        <a href="@Url.Action("AddVehicle", "Booking")" class="btn btn-primary">Add Vehicle</a>
    </div>
</div>

// Fixed JavaScript for the Manage page
@section scripts {
    <script>
        $(document).ready(function () {
            // Check for driver updates from localStorage
            @if (TempData["DriverUpdated"] != null && (bool)TempData["DriverUpdated"])
            {
                <text>
                var driverData = '@TempData["UpdatedDriver"]'.split('|');
                var driverId = driverData[0];
                var driverDetails = driverData.slice(1).join('|');
                localStorage.setItem('driver_' + driverId, driverDetails);
                </text>
            }

            // Check for new drivers from TempData
            @if (TempData["DriverAdded"] != null && (bool)TempData["DriverAdded"])
            {
                <text>
                var driverData = '@TempData["NewDriver"]'.split('|');
                var driverId = driverData[0];
                var driverDetails = driverData.slice(1).join('|');
                localStorage.setItem('driver_' + driverId, driverDetails);
                </text>
            }

            // Initialize the page
            loadDrivers();
            loadVehicles();

            // Search functionality for drivers
            $('#searchDriversBtn').click(searchDrivers);

            // Service type filter for drivers
            $('#filterServiceBtn').click(filterByServiceType);

            // Filter when service type dropdown changes
            $('#serviceTypeFilter').change(filterByServiceType);

            // Driver button handlers - FIXED
            $(document).on('click', '.edit-driver', function(e) {
                e.preventDefault();
                var driverId = $(this).data('id');
                var isLocal = $(this).data('local');

                console.log('Edit driver clicked:', driverId, 'isLocal:', isLocal); // Debug log

                // Construct the URL properly
                var url = '@Url.Action("EditDriver", "Booking")' + '?id=' + encodeURIComponent(driverId) + '&fromLocal=' + isLocal;
                console.log('Navigating to:', url); // Debug log

                window.location.href = url;
            });

            $(document).on('click', '.delete-driver', function() {
                var driverId = $(this).data('id');
                var isLocal = $(this).data('local');

                if (confirm('Are you sure you want to delete this driver?')) {
                    if (isLocal) {
                        localStorage.removeItem('driver_' + driverId);
                        loadDrivers(); // Reload the table immediately
                    } else {
                        $.post('@Url.Action("DeleteDriver", "Booking")', { id: driverId }, function() {
                            loadDrivers();
                        }).fail(function() {
                            alert('Error deleting driver');
                        });
                    }
                }
            });

            // Vehicle button handlers
            $(document).on('click', '.edit-vehicle', function(e) {
                e.preventDefault();
                var vehicleId = $(this).data('id');
                window.location.href = '@Url.Action("EditVehicle", "Booking")?id=' + encodeURIComponent(vehicleId);
            });

            $(document).on('click', '.delete-vehicle', function() {
                var vehicleId = $(this).data('id');
                var isLocal = $(this).data('local');

                if (confirm('Are you sure you want to delete this vehicle?')) {
                    if (isLocal) {
                        localStorage.removeItem('vehicle_' + vehicleId);
                        loadVehicles(); // Reload the table immediately
                    } else {
                        $.post('@Url.Action("DeleteVehicle", "Booking")', { id: vehicleId }, function() {
                            loadVehicles();
                        }).fail(function() {
                            alert('Error deleting vehicle');
                        });
                    }
                }
            });
        });

        function loadDrivers() {
            $('#driversList').empty();
            var shownIds = new Set();

            // Load from repository
            @foreach (var driver in Model.Drivers)
            {
                <text>
                if (!shownIds.has('@driver.driverID')) {
                    addDriverRow(
                        '@driver.driverID',
                        '@driver.driverFirstName',
                        '@driver.driverLastName',
                        '@driver.driverPhoneNumber',
                        '@driver.driverServiceType',
                        '@driver.driverImage',
                        false
                    );
                    shownIds.add('@driver.driverID');
                }
                </text>
            }

            // Load from localStorage
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (key && key.startsWith('driver_')) {
                    var driverId = key.replace('driver_', '');
                    if (!shownIds.has(driverId)) {
                        var driverData = localStorage.getItem(key);
                        if (driverData) {
                            var driverFields = driverData.split('|');
                            if (driverFields.length >= 4) {
                                var image = driverFields.length > 4 ? driverFields[4] : null;
                                addDriverRow(
                                    driverId,
                                    driverFields[0],
                                    driverFields[1],
                                    driverFields[2],
                                    driverFields[3],
                                    image,
                                    true
                                );
                                shownIds.add(driverId);
                            }
                        }
                    }
                }
            }
        }

        function loadVehicles() {
            $('#vehiclesList').empty();
            var shownIds = new Set();

            // Load from repository
            @foreach (var vehicle in Model.Vehicles)
            {
                <text>
                if (!shownIds.has('@vehicle.vehicleID')) {
                    addVehicleRow(
                        '@vehicle.vehicleID',
                        '@vehicle.vehicleType',
                        '@vehicle.vehicleRegistration',
                        '@vehicle.vehicleServiceType',
                        false
                    );
                    shownIds.add('@vehicle.vehicleID');
                }
                </text>
            }

            // Load from localStorage
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (key && key.startsWith('vehicle_')) {
                    var vehicleId = key.replace('vehicle_', '');
                    if (!shownIds.has(vehicleId)) {
                        var vehicleData = localStorage.getItem(key);
                        if (vehicleData) {
                            var vehicleFields = vehicleData.split('|');
                            if (vehicleFields.length === 3) {
                                addVehicleRow(
                                    vehicleId,
                                    vehicleFields[0],
                                    vehicleFields[1],
                                    vehicleFields[2],
                                    true
                                );
                                shownIds.add(vehicleId);
                            }
                        }
                    }
                }
            }
        }

        function addDriverRow(id, firstName, lastName, phone, service, image, isLocal) {
            const imageHtml = image ?
                `<img src="${image}" class="img-thumbnail" style="max-width: 50px; max-height: 50px;" />` :
                '<div class="text-muted">No image</div>';

            $('#driversList').append(
                '<tr data-service="' + service + '">' +
                '<td>' + imageHtml + '</td>' +
                '<td>' + firstName + ' ' + lastName + '</td>' +
                '<td>' + phone + '</td>' +
                '<td>' + service + '</td>' +
                '<td>' +
                '<button class="btn btn-sm btn-primary edit-driver" data-id="' + id + '" data-local="' + isLocal + '">Edit</button> ' +
                '<button class="btn btn-sm btn-danger delete-driver ml-2" data-id="' + id + '" data-local="' + isLocal + '">Delete</button>' +
                '</td>' +
                '</tr>'
            );
        }

        function addVehicleRow(id, type, registration, service, isLocal) {
            $('#vehiclesList').append(
                '<tr>' +
                '<td>' + type + '</td>' +
                '<td>' + registration + '</td>' +
                '<td>' + service + '</td>' +
                '<td>' +
                '<button class="btn btn-sm btn-primary edit-vehicle" data-id="' + id + '" data-local="' + isLocal + '">Edit</button> ' +
                '<button class="btn btn-sm btn-danger delete-vehicle ml-2" data-id="' + id + '" data-local="' + isLocal + '">Delete</button>' +
                '</td>' +
                '</tr>'
            );
        }

        function searchDrivers() {
            var searchTerm = $('#driverSearch').val().toLowerCase();
            $('#driversList tr').each(function () {
                var driverName = $(this).find('td:nth-child(2)').text().toLowerCase();
                $(this).toggle(driverName.includes(searchTerm));
            });
        }

        function filterByServiceType() {
            var selectedService = $('#serviceTypeFilter').val();
            if (!selectedService) {
                // Show all if no service type selected
                $('#driversList tr').show();
                return;
            }

            $('#driversList tr').each(function () {
                var serviceType = $(this).data('service');
                $(this).toggle(serviceType === selectedService);
            });
        }
    </script>
}